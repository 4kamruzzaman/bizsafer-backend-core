name: Backend Production Deployment

on:
  push:
    branches: [ main ]

jobs:
  # Stage 1: Test
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_mysql
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress
      - name: Run Unit Tests
        run: php artisan test

  # Stage 2: Deploy
  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh_options: -A
          script: |
            cd /var/www/bizsafer-panel
            
            # Pull private code
            git pull git@github.com:bizsafer/bizsafer-panel.git main
            
            # Rebuild Containers
            docker-compose up -d --build
            
            # Run Database Migrations
            docker-compose exec -T backend php artisan migrate --force
            
            # Verify Health (Stage 3)
            echo "Checking API Health..."
            sleep 30
            if [ "$(docker inspect -f '{{.State.Status}}' bizsafer_backend)" != "running" ]; then
               echo "Backend crashed!"
               exit 1
            fi
